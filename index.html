<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0d1b2a">
<meta name="description" content="Veldindeling Varssel Airport op basis van actuele windrichting">
<title>Varssel Airport ‚Äì Hoogvliegers</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>‚úàÔ∏è</text></svg>">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
  :root {
    --bg-deep: #0d1b2a;
    --bg-mid: #1b2838;
    --bg-light: #263238;
    --accent: #FF9800;
    --accent-dark: #E65100;
    --accent-glow: rgba(255,152,0,0.15);
    --text: #ECEFF1;
    --text-dim: #90A4AE;
    --text-muted: #546E7A;
    --card: rgba(255,255,255,0.05);
    --card-border: rgba(255,255,255,0.08);
    --green: #558B2F;
    --blue: #4FC3F7;
    --red: #D32F2F;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

  body {
    font-family: 'DM Sans', sans-serif;
    background: linear-gradient(180deg, var(--bg-deep) 0%, var(--bg-mid) 40%, var(--bg-light) 100%);
    color: var(--text);
    min-height: 100vh;
    min-height: 100dvh;
    overflow-x: hidden;
  }

  /* Loading screen */
  #loading {
    position: fixed; inset: 0; z-index: 100;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    background: linear-gradient(135deg, var(--bg-deep), var(--bg-mid), var(--bg-deep));
    transition: opacity 0.5s, visibility 0.5s;
  }
  #loading.hidden { opacity: 0; visibility: hidden; pointer-events: none; }

  .spinner {
    width: 56px; height: 56px;
    border: 3px solid rgba(255,152,0,0.15);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.9s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  .loading-text { margin-top: 20px; font-size: 15px; font-weight: 600; letter-spacing: 1px; }
  .loading-sub { margin-top: 6px; font-size: 12px; color: var(--text-dim); }

  /* Header */
  .header {
    background: rgba(0,0,0,0.35); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
    padding: 16px 20px 14px;
    border-bottom: 1px solid var(--card-border);
    position: sticky; top: 0; z-index: 50;
  }
  .header-inner { display: flex; align-items: center; justify-content: space-between; max-width: 480px; margin: 0 auto; }
  .club-name { font-size: 10px; font-weight: 700; color: var(--accent); letter-spacing: 2.5px; text-transform: uppercase; }
  .airport-name { font-size: 20px; font-weight: 800; margin-top: 2px; letter-spacing: -0.5px; }
  .layout-badge { text-align: right; }
  .layout-id { font-size: 28px; font-weight: 800; color: var(--accent); line-height: 1; }
  .layout-wind { font-size: 11px; color: var(--text-dim); margin-top: 2px; }

  /* Content */
  .content { padding: 16px 16px 40px; max-width: 480px; margin: 0 auto; }

  /* Cards */
  .card {
    background: var(--card); border: 1px solid var(--card-border);
    border-radius: 14px; padding: 14px 16px; margin-bottom: 10px;
  }

  /* Wind info */
  .wind-card { display: flex; align-items: center; gap: 16px; }
  .wind-details { flex: 1; }
  .wind-label { font-size: 12px; color: var(--text-dim); margin-bottom: 3px; }
  .wind-main { font-size: 22px; font-weight: 800; }
  .wind-main .deg { color: var(--accent); }
  .wind-stats { font-size: 13px; color: #B0BEC5; margin-top: 4px; }
  .wind-extra { font-size: 12px; color: var(--text-muted); margin-top: 2px; }
  .wind-manual-badge { font-size: 11px; color: var(--accent); font-style: italic; margin-top: 4px; }

  /* Update bar */
  .update-bar { display: flex; justify-content: space-between; align-items: center; padding: 0 4px; margin-bottom: 10px; }
  .update-time { font-size: 11px; color: var(--text-muted); }
  .refresh-btn {
    background: none; border: 1px solid rgba(255,255,255,0.12); border-radius: 6px;
    padding: 5px 12px; color: var(--text-dim); font-size: 11px; cursor: pointer;
    font-family: inherit; transition: border-color 0.2s;
  }
  .refresh-btn:active { border-color: var(--accent); color: var(--accent); }

  /* Mais toggle */
  .toggle-row { display: flex; align-items: center; justify-content: space-between; }
  .toggle-label { font-size: 13px; font-weight: 600; }
  .toggle-sub { font-size: 11px; color: var(--text-muted); margin-top: 1px; }
  .toggle {
    width: 48px; height: 28px; border-radius: 14px; cursor: pointer;
    background: rgba(255,255,255,0.12); position: relative; transition: background 0.3s;
    flex-shrink: 0; border: none; outline: none;
  }
  .toggle.on { background: var(--accent); }
  .toggle-knob {
    width: 22px; height: 22px; border-radius: 11px; background: white;
    position: absolute; top: 3px; left: 3px; transition: left 0.3s;
    box-shadow: 0 2px 6px rgba(0,0,0,0.3);
  }
  .toggle.on .toggle-knob { left: 23px; }

  /* Manual wind */
  .manual-title { font-size: 13px; font-weight: 600; margin-bottom: 10px; }
  .wind-btns { display: flex; flex-wrap: wrap; gap: 6px; justify-content: center; }
  .wind-btn {
    background: rgba(255,255,255,0.07); border: 1px solid rgba(255,255,255,0.12);
    border-radius: 8px; padding: 9px 15px; color: white; font-size: 12px; font-weight: 600;
    cursor: pointer; font-family: inherit; transition: all 0.2s;
  }
  .wind-btn:active, .wind-btn.active { background: var(--accent-glow); border-color: var(--accent); color: var(--accent); }

  /* Field map */
  .map-card {
    background: white; border-radius: 16px; padding: 10px 6px 4px;
    margin: 16px 0; box-shadow: 0 8px 40px rgba(0,0,0,0.35);
    border: none;
  }

  /* Legend */
  .legend-title { font-size: 12px; font-weight: 700; color: #B0BEC5; margin-bottom: 8px; }
  .legend-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 6px 16px; }
  .legend-item { display: flex; align-items: center; gap: 8px; font-size: 11px; color: #B0BEC5; }
  .legend-swatch { width: 16px; height: 10px; border-radius: 2px; flex-shrink: 0; }
  .legend-swatch.dashed { height: 0; border-top: 2px dashed; }

  /* Safety rules */
  .safety-btn {
    width: 100%; background: rgba(230,81,0,0.15); border: 1px solid var(--accent-dark);
    border-radius: 12px; padding: 14px 16px; cursor: pointer;
    color: var(--accent); font-size: 14px; font-weight: 700; font-family: inherit;
    text-align: left; transition: all 0.3s; margin-top: 2px;
  }
  .safety-btn.open { background: var(--accent-dark); color: white; }

  .safety-panel {
    background: #FFF3E0; border-radius: 12px; padding: 14px 16px;
    margin-top: 8px; border: 1px solid #FFE0B2;
    display: none;
  }
  .safety-panel.open { display: block; animation: slideDown 0.3s ease; }
  @keyframes slideDown { from { opacity: 0; transform: translateY(-8px); } to { opacity: 1; transform: translateY(0); } }

  .safety-title { font-weight: 700; font-size: 14px; color: var(--accent-dark); margin-bottom: 8px; }
  .safety-rule { font-size: 12px; color: #4E342E; margin-bottom: 6px; display: flex; gap: 8px; line-height: 1.45; }

  /* Error */
  .error-screen {
    position: fixed; inset: 0; z-index: 90;
    display: none; flex-direction: column; align-items: center; justify-content: center;
    background: linear-gradient(135deg, var(--bg-deep), var(--bg-mid), var(--bg-deep));
    padding: 32px;
  }
  .error-screen.show { display: flex; }
  .error-icon { font-size: 48px; margin-bottom: 16px; }
  .error-title { font-size: 18px; font-weight: 700; margin-bottom: 8px; }
  .error-text { font-size: 13px; color: var(--text-dim); text-align: center; max-width: 280px; margin-bottom: 24px; }
  .retry-btn {
    background: var(--accent); color: white; border: none; border-radius: 8px;
    padding: 12px 36px; font-size: 14px; font-weight: 700; cursor: pointer; font-family: inherit;
  }

  /* Footer */
  .footer { text-align: center; margin-top: 24px; padding: 12px 0; }
  .footer-line { font-size: 10px; color: #455A64; }
  .footer-sub { font-size: 9px; color: #37474F; margin-top: 4px; }

  /* Fade in animation */
  .fade-in { animation: fadeIn 0.6s ease; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }
</style>
</head>
<body>

<!-- Loading screen -->
<div id="loading">
  <div class="spinner"></div>
  <div class="loading-text">Wind data ophalen...</div>
  <div class="loading-sub">Varssel Airport</div>
</div>

<!-- Error screen -->
<div id="error" class="error-screen">
  <div class="error-icon">üå¨Ô∏è</div>
  <div class="error-title">Geen winddata beschikbaar</div>
  <div class="error-text">Controleer je internetverbinding en probeer opnieuw.</div>
  <button class="retry-btn" onclick="fetchWind()">Opnieuw proberen</button>
</div>

<!-- Main app -->
<div id="app" style="display:none;">
  <!-- Header -->
  <div class="header">
    <div class="header-inner">
      <div>
        <div class="club-name">Modelbouw Club Hoogvliegers</div>
        <div class="airport-name">Varssel Airport</div>
      </div>
      <div class="layout-badge">
        <div class="layout-id" id="layoutId">P1</div>
        <div class="layout-wind" id="layoutWind">Noordenwind</div>
      </div>
    </div>
  </div>

  <div class="content">
    <!-- Wind info -->
    <div class="card wind-card fade-in">
      <div id="compass-container"></div>
      <div class="wind-details">
        <div class="wind-label">Huidige wind</div>
        <div class="wind-main" id="windMain">N <span class="deg">0¬∞</span></div>
        <div class="wind-stats" id="windStats">0 m/s ¬∑ Bft 0 ¬∑ Windstil</div>
        <div class="wind-extra" id="windGusts"></div>
        <div class="wind-extra" id="windTemp"></div>
        <div class="wind-manual-badge" id="manualBadge" style="display:none;">‚ö†Ô∏è Handmatig ingesteld</div>
      </div>
    </div>

    <!-- Update bar -->
    <div class="update-bar">
      <div class="update-time" id="updateTime"></div>
      <button class="refresh-btn" onclick="fetchWind()">üîÑ Vernieuwen</button>
    </div>

    <!-- Mais toggle -->
    <div class="card fade-in">
      <div class="toggle-row">
        <div>
          <div class="toggle-label">üåΩ Mais rondom het veld</div>
          <div class="toggle-sub">Activeert P5/P6 bij oost- of westenwind</div>
        </div>
        <button class="toggle" id="maisToggle" onclick="toggleMais()">
          <div class="toggle-knob"></div>
        </button>
      </div>
    </div>

    <!-- Manual wind -->
    <div class="card fade-in">
      <div class="manual-title">üß≠ Handmatig windrichting kiezen</div>
      <div class="wind-btns" id="windBtns"></div>
    </div>

    <!-- Field map -->
    <div class="map-card fade-in" id="mapCard"></div>

    <!-- Legend -->
    <div class="card fade-in">
      <div class="legend-title">Legenda</div>
      <div class="legend-grid">
        <div class="legend-item"><div class="legend-swatch" style="background:#4FC3F7"></div>Start/landing richting</div>
        <div class="legend-item"><div class="legend-swatch" style="background:#FF9800"></div>Windrichting</div>
        <div class="legend-item"><div class="legend-swatch" style="background:#D32F2F"></div>Piloot positie</div>
        <div class="legend-item"><div class="legend-swatch dashed" style="border-color:#FF6D00"></div>Vliegcircuit</div>
        <div class="legend-item"><div class="legend-swatch" style="background:#90A4AE"></div>Parkeren vliegtuigen</div>
        <div class="legend-item"><div class="legend-swatch" style="background:none;border:1.5px solid #455A64"></div>Drone veld</div>
      </div>
    </div>

    <!-- Safety -->
    <button class="safety-btn" id="safetyBtn" onclick="toggleSafety()">‚ö†Ô∏è Veiligheidsregels ‚ñº</button>
    <div class="safety-panel" id="safetyPanel">
      <div class="safety-title">‚ö†Ô∏è Veiligheidsregels</div>
      <div class="safety-rule"><span>‚úàÔ∏è</span><span>Start en land tegen de wind in</span></div>
      <div class="safety-rule"><span>üõ£Ô∏è</span><span>Min. 20m hoogte boven Varsselseweg, 15m boven Antinkweg</span></div>
      <div class="safety-rule"><span>‚¨áÔ∏è</span><span>Min. 6m hoogte boven verharde weg bij landing</span></div>
      <div class="safety-rule"><span>üö´</span><span>Vlieg NOOIT over personen, fietsers of voertuigen</span></div>
      <div class="safety-rule"><span>üëÄ</span><span>Let op verkeer bij start en landing over wegen</span></div>
      <div class="safety-rule"><span>üöÅ</span><span>Drone-piloten brevet: binnen droneveld. Rondvliegen: bij vliegtuigpiloten</span></div>
    </div>

    <!-- Footer -->
    <div class="footer">
      <div class="footer-line">Modelbouw Club Hoogvliegers ¬∑ Varssel Airport</div>
      <div class="footer-sub">Winddata: Open-Meteo ¬∑ Vernieuwt elke 10 min</div>
    </div>
  </div>
</div>

<script>
// ‚îÄ‚îÄ State ‚îÄ‚îÄ
let windData = null;
let hasMais = false;
let isManual = false;
let safetyOpen = false;

// ‚îÄ‚îÄ Constants ‚îÄ‚îÄ
const LAT = 52.06, LON = 6.25;

// ‚îÄ‚îÄ Wind helpers ‚îÄ‚îÄ
function getLayout(deg, mais) {
  const d = ((deg % 360) + 360) % 360;
  if (d >= 315 || d < 45) return { id: 'P1', wind: 'Noordenwind' };
  if (d >= 45 && d < 135) return { id: mais ? 'P5' : 'P2', wind: 'Oostenwind' };
  if (d >= 135 && d < 225) return { id: 'P3', wind: 'Zuidenwind' };
  return { id: mais ? 'P6' : 'P4', wind: 'Westenwind' };
}

function windDirName(deg) {
  const dirs = ['N','NNO','NO','ONO','O','OZO','ZO','ZZO','Z','ZZW','ZW','WZW','W','WNW','NW','NNW'];
  return dirs[Math.round(deg / 22.5) % 16];
}

function beaufort(ms) {
  if (ms < 0.3) return { f: 0, l: 'Windstil' };
  if (ms < 1.6) return { f: 1, l: 'Zwak' };
  if (ms < 3.4) return { f: 2, l: 'Zwak' };
  if (ms < 5.5) return { f: 3, l: 'Matig' };
  if (ms < 8.0) return { f: 4, l: 'Matig' };
  if (ms < 10.8) return { f: 5, l: 'Vrij krachtig' };
  if (ms < 13.9) return { f: 6, l: 'Krachtig' };
  if (ms < 17.2) return { f: 7, l: 'Hard' };
  return { f: '8+', l: 'Stormachtig' };
}

// ‚îÄ‚îÄ Compass SVG ‚îÄ‚îÄ
function renderCompass(deg, speed) {
  const ticks = Array.from({length:36}, (_,i) => {
    const a = i*10, rad = (a-90)*Math.PI/180;
    const major = i%9===0;
    const r1 = major ? 33 : 37, r2 = 40;
    const sw = major ? 1.5 : 0.5;
    const col = major ? '#78909C' : '#37474F';
    return `<line x1="${60+Math.cos(rad)*r1}" y1="${60+Math.sin(rad)*r1}" x2="${60+Math.cos(rad)*r2}" y2="${60+Math.sin(rad)*r2}" stroke="${col}" stroke-width="${sw}"/>`;
  }).join('');

  const cardinals = [{a:0,l:'N'},{a:90,l:'O'},{a:180,l:'Z'},{a:270,l:'W'}].map(c => {
    const rad = (c.a-90)*Math.PI/180;
    const x = 60+Math.cos(rad)*44, y = 60+Math.sin(rad)*44+3;
    const col = c.l==='N' ? '#FF5722' : '#90A4AE';
    return `<text x="${x}" y="${y}" text-anchor="middle" font-size="10" font-weight="700" fill="${col}" font-family="'DM Sans',sans-serif">${c.l}</text>`;
  }).join('');

  return `<svg viewBox="0 0 120 120" style="width:100px;height:100px;flex-shrink:0">
    <defs><linearGradient id="cg" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#1a2332"/><stop offset="100%" stop-color="#0d1520"/></linearGradient></defs>
    <circle cx="60" cy="60" r="56" fill="url(#cg)" stroke="#37474F" stroke-width="2"/>
    <circle cx="60" cy="60" r="50" fill="none" stroke="#455A64" stroke-width="0.5"/>
    <line x1="60" y1="42" x2="60" y2="78" stroke="#263238" stroke-width="0.5"/>
    <line x1="42" y1="60" x2="78" y2="60" stroke="#263238" stroke-width="0.5"/>
    ${ticks}${cardinals}
    <g transform="rotate(${deg},60,60)">
      <line x1="60" y1="32" x2="60" y2="78" stroke="#FF9800" stroke-width="2.5" stroke-linecap="round"/>
      <polygon points="60,30 53,42 67,42" fill="#FF9800"/>
    </g>
    <circle cx="60" cy="60" r="3" fill="#FF9800"/>
    <text x="60" y="65" text-anchor="middle" font-size="8" fill="#B0BEC5" font-family="'DM Sans',sans-serif">${speed.toFixed(1)} m/s</text>
  </svg>`;
}

// ‚îÄ‚îÄ Field layout SVG ‚îÄ‚îÄ
function renderField(layoutId) {
  const fieldPath = "M 60,100 Q 180,80 370,95 Q 380,100 385,110 Q 370,200 330,350 Q 300,420 270,470 L 260,475 Q 200,400 130,280 Q 90,210 60,100 Z";
  const varsselseweg = "M 20,85 Q 180,60 400,78";
  const varsselsewegBottom = "M 30,110 Q 180,90 390,108";
  const antinkweg = "M 390,108 Q 380,200 340,350 Q 310,430 280,490";
  const antinkwegLeft = "M 370,95 Q 360,190 325,340 Q 295,420 265,480";
  const roadFill1 = "M 20,85 Q 180,60 400,78 L 390,108 Q 180,90 30,110 Z";
  const roadFill2 = "M 390,108 Q 380,200 340,350 Q 310,430 280,490 L 265,480 Q 295,420 325,340 Q 360,190 370,95 L 390,108 Z";

  // Layout definitions
  const layouts = {
    P1: { px:295,py:340,pr:-55,pc:6, dx:270,dy:280,dw:45,dh:55, sx:195,sy:245,sd:'up', f1x:265,f1y:215,f2x:230,f2y:330, fp:"M230,330 L265,215", wx:210,wy:115,wd:'down', mais:false },
    P2: { px:130,py:140,pr:0,pc:6, px2:68,py2:155,pr2:-55,pc2:3, dx:200,dy:150,dw:50,dh:45, sx:210,sy:265,sd:'right', f1x:245,f1y:195,f2x:110,f2y:195, fp:"M110,195 L245,195", wx:370,wy:260,wd:'left', mais:false },
    P3: { px:330,py:210,pr:-55,pc:6, dx:270,dy:310,dw:45,dh:55, sx:175,sy:175,sd:'down', f1x:250,f1y:195,f2x:220,f2y:310, fp:"M250,195 L220,310", wx:170,wy:420,wd:'up', mais:false },
    P4: { px:330,py:250,pr:-55,pc:6, dx:255,dy:340,dw:45,dh:55, sx:230,sy:205,sd:'left', f1x:270,f1y:240,f2x:170,f2y:275, fp:"M170,275 L270,240", wx:55,wy:290,wd:'right', mais:false },
    P5: { px:320,py:285,pr:-55,pc:6, dx:255,dy:370,dw:45,dh:55, sx:215,sy:220,sd:'right', f1x:275,f1y:250,f2x:155,f2y:290, fp:"M155,290 L275,250", wx:370,wy:280,wd:'left', mais:true },
    P6: { px:240,py:150,pr:0,pc:6, dx:115,dy:170,dw:50,dh:45, sx:215,sy:280,sd:'left', f1x:310,f1y:210,f2x:125,f2y:225, fp:"M125,225 L310,210", wx:55,wy:305,wd:'right', mais:true },
  };
  const L = layouts[layoutId];

  // Arrow helpers
  function arrow(x,y,dir,type) {
    const rots = { up:0, down:180, left:-90, right:90 };
    const r = rots[dir];
    const fill = type==='wind' ? '#FF9800' : '#4FC3F7';
    const stroke = type==='wind' ? '#E65100' : '#0288D1';
    const rw = type==='wind' ? 20 : 18;
    const rh = type==='wind' ? 9 : 8;
    const tp = type==='wind' ? 22 : 20;
    const tw = type==='wind' ? 16 : 14;
    let label = '';
    if (type === 'start') {
      const ly = dir==='up' ? 28 : dir==='down' ? -20 : 25;
      label = `<text y="${ly}" text-anchor="middle" font-size="9" font-weight="600" fill="#01579B" font-family="'DM Sans',sans-serif">Start/landing</text>`;
    }
    return `<g transform="translate(${x},${y})"><g transform="rotate(${r})"><rect x="${-rw}" y="${-rh}" width="${rw*2}" height="${rh*2}" rx="3" fill="${fill}" stroke="${stroke}" stroke-width="1.5"/><polygon points="0,${-tp} ${tw},${-rh+2} ${-tw},${-rh+2}" fill="${fill}" stroke="${stroke}" stroke-width="1.5"/></g>${label}</g>`;
  }

  // Parking
  function parking(x,y,rot,count) {
    const cols = Math.min(count,3), rows = Math.ceil(count/3);
    const cw=18,ch=12,gap=3;
    const tw = cols*cw+(cols-1)*gap+10, th = rows*ch+(rows-1)*gap+10;
    let cars = '';
    for (let i=0;i<count;i++) {
      const col=i%cols, row=Math.floor(i/cols);
      const cx = -tw/2+5+col*(cw+gap)+cw/2, cy = -th/2+5+row*(ch+gap)+ch/2;
      const clr = i===0 ? '#4CAF50' : '#90A4AE';
      cars += `<rect x="${cx-cw/2}" y="${cy-ch/2}" width="${cw}" height="${ch}" rx="3" fill="${clr}" opacity="0.8"/>`;
    }
    return `<g transform="translate(${x},${y}) rotate(${rot||0})">
      <rect x="${-tw/2}" y="${-th/2}" width="${tw}" height="${th}" rx="3" fill="white" stroke="#455A64" stroke-width="1.5"/>
      ${cars}
      <text y="${th/2+13}" text-anchor="middle" font-size="8.5" font-weight="600" fill="#37474F" font-family="'DM Sans',sans-serif" transform="rotate(${-(rot||0)})">Vliegtuigen</text>
    </g>`;
  }

  function drone(x,y,w,h) {
    return `<g><rect x="${x-w/2}" y="${y-h/2}" width="${w}" height="${h}" rx="3" fill="none" stroke="#455A64" stroke-width="1.5"/><text x="${x}" y="${y+4}" text-anchor="middle" font-size="9" font-weight="600" fill="#37474F" font-family="'DM Sans',sans-serif">Drones</text></g>`;
  }

  function flag(x,y) {
    return `<g transform="translate(${x},${y})"><line x1="0" y1="0" x2="0" y2="-16" stroke="#5D4037" stroke-width="1.5"/><polygon points="0,-16 14,-12 0,-8" fill="#D32F2F" stroke="#B71C1C" stroke-width="0.8"/></g>`;
  }

  const maisLabels = L.mais ? `<text x="240" y="75" text-anchor="middle" font-size="20" font-weight="800" fill="#689F38" font-family="'DM Sans',sans-serif" opacity="0.65">MAIS</text><text x="365" y="320" text-anchor="middle" font-size="20" font-weight="800" fill="#689F38" font-family="'DM Sans',sans-serif" opacity="0.65">MAIS</text>` : '';

  const extraParking = L.px2 ? parking(L.px2,L.py2,L.pr2,L.pc2) : '';

  // Scale bar
  let scaleBar = '';
  for (let i=0;i<6;i++) {
    const fill = i%2===0 ? '#263238' : 'white';
    scaleBar += `<rect x="${i*28}" y="0" width="28" height="4" fill="${fill}" stroke="#263238" stroke-width="0.5"/>`;
    scaleBar += `<text x="${i*28}" y="-3" text-anchor="middle" font-size="7" fill="#546E7A" font-family="'DM Sans',sans-serif">${i*10}</text>`;
  }
  scaleBar += `<text x="140" y="-3" text-anchor="middle" font-size="7" fill="#546E7A" font-family="'DM Sans',sans-serif">50m</text>`;

  return `<svg viewBox="0 0 420 520" style="width:100%;max-width:440px;height:auto;display:block">
    <rect width="420" height="520" fill="#FAFAF5" rx="12"/>
    <!-- Roads -->
    <path d="${roadFill1}" fill="#E0E0E0" opacity="0.5"/>
    <path d="${roadFill2}" fill="#E0E0E0" opacity="0.5"/>
    <path d="${varsselseweg}" fill="none" stroke="#9E9E9E" stroke-width="2"/>
    <path d="${varsselsewegBottom}" fill="none" stroke="#9E9E9E" stroke-width="2"/>
    <path d="${varsselseweg}" fill="none" stroke="#BDBDBD" stroke-width="0.5" stroke-dasharray="6,4"/>
    <path d="${antinkweg}" fill="none" stroke="#9E9E9E" stroke-width="2"/>
    <path d="${antinkwegLeft}" fill="none" stroke="#9E9E9E" stroke-width="2"/>
    <!-- Field -->
    <path d="${fieldPath}" fill="#C5E1A5" fill-opacity="0.4" stroke="#558B2F" stroke-width="2"/>
    <!-- Road labels -->
    <text x="190" y="77" text-anchor="middle" font-size="12" font-style="italic" font-weight="500" fill="#616161" font-family="'DM Sans',sans-serif">Varsselseweg</text>
    <text transform="translate(340,395) rotate(-65)" text-anchor="middle" font-size="12" font-style="italic" font-weight="500" fill="#616161" font-family="'DM Sans',sans-serif">Antinkweg</text>
    <!-- Gate -->
    <g transform="translate(52,102)"><rect x="-6" y="-6" width="12" height="12" rx="2" fill="none" stroke="#795548" stroke-width="1.5"/><line x1="-3" y1="6" x2="-3" y2="10" stroke="#795548" stroke-width="1.5"/><line x1="3" y1="6" x2="3" y2="10" stroke="#795548" stroke-width="1.5"/></g>
    ${maisLabels}
    <!-- Flight path -->
    <path d="${L.fp}" fill="none" stroke="#FF6D00" stroke-width="1.5" stroke-dasharray="6,4"/>
    <!-- Flags -->
    ${flag(L.f1x,L.f1y)}${flag(L.f2x,L.f2y)}
    <!-- Parking -->
    ${parking(L.px,L.py,L.pr,L.pc)}${extraParking}
    <!-- Drones -->
    ${drone(L.dx,L.dy,L.dw,L.dh)}
    <!-- Start/landing -->
    ${arrow(L.sx,L.sy,L.sd,'start')}
    <!-- Wind -->
    ${arrow(L.wx,L.wy,L.wd,'wind')}
    <!-- Compass rose -->
    <g transform="translate(385,42)">
      <circle r="22" fill="white" fill-opacity="0.85" stroke="#78909C" stroke-width="1"/>
      <line x1="0" y1="-18" x2="0" y2="18" stroke="#B0BEC5" stroke-width="0.5"/>
      <line x1="-18" y1="0" x2="18" y2="0" stroke="#B0BEC5" stroke-width="0.5"/>
      <text y="-11" text-anchor="middle" font-size="9" font-weight="700" fill="#263238" font-family="'DM Sans',sans-serif">N</text>
      <text y="18" text-anchor="middle" font-size="8" fill="#546E7A" font-family="'DM Sans',sans-serif">Z</text>
      <text x="14" y="4" text-anchor="middle" font-size="8" fill="#546E7A" font-family="'DM Sans',sans-serif">O</text>
      <text x="-14" y="4" text-anchor="middle" font-size="8" fill="#546E7A" font-family="'DM Sans',sans-serif">W</text>
    </g>
    <!-- Layout ID -->
    <text x="30" y="45" font-size="28" font-weight="800" fill="#263238" font-family="'DM Sans',sans-serif">${layoutId}</text>
    <!-- Scale -->
    <g transform="translate(120,495)">${scaleBar}</g>
  </svg>`;
}

// ‚îÄ‚îÄ UI Update ‚îÄ‚îÄ
function updateUI() {
  if (!windData) return;
  const layout = getLayout(windData.direction, hasMais);
  const bft = beaufort(windData.speed);
  const dirName = windDirName(windData.direction);

  document.getElementById('layoutId').textContent = layout.id;
  document.getElementById('layoutWind').textContent = layout.wind;
  document.getElementById('windMain').innerHTML = `${dirName} <span class="deg">${Math.round(windData.direction)}¬∞</span>`;
  document.getElementById('windStats').textContent = `${windData.speed.toFixed(1)} m/s ¬∑ Bft ${bft.f} ¬∑ ${bft.l}`;

  const gustsEl = document.getElementById('windGusts');
  if (windData.gusts > 0) {
    gustsEl.textContent = `Vlagen tot ${windData.gusts.toFixed(1)} m/s`;
    gustsEl.style.display = '';
  } else gustsEl.style.display = 'none';

  const tempEl = document.getElementById('windTemp');
  if (windData.temperature !== null) {
    tempEl.textContent = `üå°Ô∏è ${windData.temperature.toFixed(1)}¬∞C`;
    tempEl.style.display = '';
  } else tempEl.style.display = 'none';

  document.getElementById('manualBadge').style.display = isManual ? '' : 'none';
  document.getElementById('compass-container').innerHTML = renderCompass(windData.direction, windData.speed);
  document.getElementById('mapCard').innerHTML = renderField(layout.id);
}

// ‚îÄ‚îÄ Fetch wind data ‚îÄ‚îÄ
async function fetchWind() {
  document.getElementById('loading').classList.remove('hidden');
  document.getElementById('error').classList.remove('show');
  try {
    const url = `https://api.open-meteo.com/v1/forecast?latitude=${LAT}&longitude=${LON}&current=wind_speed_10m,wind_direction_10m,wind_gusts_10m,temperature_2m,weather_code&timezone=Europe/Amsterdam`;
    const res = await fetch(url);
    if (!res.ok) throw new Error('Fetch failed');
    const data = await res.json();
    windData = {
      direction: data.current.wind_direction_10m,
      speed: data.current.wind_speed_10m / 3.6,
      gusts: data.current.wind_gusts_10m / 3.6,
      temperature: data.current.temperature_2m,
    };
    isManual = false;
    const now = new Date();
    document.getElementById('updateTime').textContent = `Bijgewerkt: ${now.toLocaleTimeString('nl-NL',{hour:'2-digit',minute:'2-digit'})}`;
    document.getElementById('app').style.display = '';
    document.getElementById('error').classList.remove('show');
    updateUI();
  } catch(e) {
    console.error(e);
    if (!windData) {
      document.getElementById('error').classList.add('show');
    }
  }
  document.getElementById('loading').classList.add('hidden');
}

// ‚îÄ‚îÄ Manual wind ‚îÄ‚îÄ
function setManualWind(deg) {
  windData = { direction: deg, speed: 3, gusts: 5, temperature: null };
  isManual = true;
  document.getElementById('updateTime').textContent = '';
  document.getElementById('app').style.display = '';
  document.getElementById('error').classList.remove('show');
  document.getElementById('loading').classList.add('hidden');

  // Highlight active button
  document.querySelectorAll('.wind-btn').forEach(btn => {
    btn.classList.toggle('active', parseInt(btn.dataset.deg) === deg);
  });
  updateUI();
}

// ‚îÄ‚îÄ Mais toggle ‚îÄ‚îÄ
function toggleMais() {
  hasMais = !hasMais;
  document.getElementById('maisToggle').classList.toggle('on', hasMais);
  updateUI();
}

// ‚îÄ‚îÄ Safety toggle ‚îÄ‚îÄ
function toggleSafety() {
  safetyOpen = !safetyOpen;
  const btn = document.getElementById('safetyBtn');
  const panel = document.getElementById('safetyPanel');
  btn.classList.toggle('open', safetyOpen);
  btn.innerHTML = safetyOpen ? '‚ö†Ô∏è Veiligheidsregels ‚ñ≤' : '‚ö†Ô∏è Veiligheidsregels ‚ñº';
  panel.classList.toggle('open', safetyOpen);
}

// ‚îÄ‚îÄ Init ‚îÄ‚îÄ
(function init() {
  // Build manual wind buttons
  const dirs = [{l:'N',d:0},{l:'NO',d:45},{l:'O',d:90},{l:'ZO',d:135},{l:'Z',d:180},{l:'ZW',d:225},{l:'W',d:270},{l:'NW',d:315}];
  const container = document.getElementById('windBtns');
  dirs.forEach(dir => {
    const btn = document.createElement('button');
    btn.className = 'wind-btn';
    btn.textContent = dir.l;
    btn.dataset.deg = dir.d;
    btn.onclick = () => setManualWind(dir.d);
    container.appendChild(btn);
  });

  // Fetch wind data
  fetchWind();

  // Auto-refresh every 10 minutes
  setInterval(fetchWind, 600000);
})();
</script>
</body>
</html>
